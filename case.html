<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>Case | Contrast Lab</title>
  <link rel="stylesheet" href="./assets/css/app.css"/>
  <style>
    #mount{ position: relative; }
    #mount .viewport{ transform-origin: top left; }
  </style>
</head>
<body>
<svg width="0" height="0" style="position:absolute" aria-hidden="true" focusable="false">
  <filter id="cvd-none"><feColorMatrix type="matrix"
    values="1 0 0 0 0
            0 1 0 0 0
            0 0 1 0 0
            0 0 0 1 0"/></filter>

  <filter id="cvd-protanopia"><feColorMatrix type="matrix"
    values="0.56667 0.43333 0 0 0
            0.55833 0.44167 0 0 0
            0 0.24167 0.75833 0 0
            0 0 0 1 0"/></filter>
  <filter id="cvd-deuteranopia"><feColorMatrix type="matrix"
    values="0.625 0.375 0 0 0
            0.70 0.30 0 0 0
            0 0.30 0.70 0 0
            0 0 0 1 0"/></filter>
  <filter id="cvd-tritanopia"><feColorMatrix type="matrix"
    values="0.95 0.05 0 0 0
            0 0.43333 0.56667 0 0
            0 0.475 0.525 0 0
            0 0 0 1 0"/></filter>
</svg>

<div class="container sim-root" id="simRoot" data-sim="none">
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1 id="h1">Case</h1>
        <div class="sub">Single‑case view for page‑by‑page tools.</div>
      </div>
    </div>
    <div class="controls">
      <div class="field">
      <label for="sim">Vision</label>
      <select id="sim">
        <option value="none">normal</option>
        <option value="blur">blur</option>
        <option value="low-contrast">low‑contrast display</option>
        <option value="glare">glare</option>
        <option value="protanopia">protanopia</option>
        <option value="deuteranopia">deuteranopia</option>
        <option value="tritanopia">tritanopia</option>
      </select>
    </div>
      <div class="field">
      <label for="btnFreeze">Freeze motion</label>
      <button class="btn dropdown" id="btnFreeze" type="button" title="Disables animations/transitions to keep rendering stable for tools and screenshots.">Off</button>
    </div>
      <a class="btn" href="./index.html">Back</a>
    </div>
  </div>


  <div class="card" id="markCard">
    <div class="cardbody">
      <div class="controls" style="flex-wrap:wrap">
        <label for="tool">Tool</label>
        <input class="input" id="tool" placeholder="Tool name" size="14" />
        <span class="badge" id="toolBadge">—</span>

        <label for="user">Human interpretation</label>
        <input class="input" id="user" placeholder="Name / initials" size="14" />
        <span class="badge" id="userBadge">—</span>

        <button class="btn" id="btnPrev" type="button">Prev (P)</button>
        <button class="btn" id="btnNext" type="button">Next (N)</button>
      </div>
      <p class="note" style="margin:10px 0 0 0">
        Run the tool on this page. Record PASS/FAIL/REVIEW in the Playground to avoid tool reloads.
        Hotkeys: N/P to navigate, F to Freeze.
      </p>
    </div>
  </div>


  <div class="card">
    <div class="cardhead">
      <div>
        <p class="title" id="caseTitle">—</p>
        <div class="meta" id="caseMeta"></div>
      </div>
    </div>
    <div class="cardbody">
      <div class="sim-cvd" id="mount">
        <div class="viewport"><span class="label">loading…</span></div>
      </div>

      <p class="note" id="notesText" style="display:none"></p>
    </div>
  </div>

  <p class="smallprint">Freeze stops animations for screenshot‑based tools.</p>
</div>

<script>
  const $ = (s, el=document) => el.querySelector(s);




  async function fetchJSON(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.json(); }
  async function fetchText(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.text(); }

  function setFreeze(on){
    document.documentElement.classList.toggle("freeze", on);
    $("#btnFreeze").textContent = on ? "On" : "Off";
    $("#btnFreeze").dataset.on = on ? "1" : "0";
  }
  function setSim(mode){
    $("#simRoot").setAttribute("data-sim", mode);
  }

  function badgeClass(expected){
    if(expected==="pass") return "pass";
    if(expected==="fail") return "fail";
    return "review";
  }
  function displayTitle(title){
    return String(title || "").replace(/\s*—\s*(PASS|FAIL|REVIEW)\b/i, "").trim();
  }

  function qsParam(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  async function main(){
    const id = qsParam("id");
    if(!id) throw new Error("Missing ?id=...");

    const manifest = await fetchJSON("./manifest.json");
    const c = manifest.cases.find(x => x.id === id);
    if(!c) throw new Error("Case not found: " + id);
    const idx = manifest.cases.findIndex(x => x.id === id);

    function setTool(name){
      const t = (name || "").trim();
      $("#toolBadge").textContent = t || "—";
      return t;
    }
    function go(delta){
      const target = idx + delta;
      if(target < 0 || target >= manifest.cases.length) return;
      const nextId = manifest.cases[target].id;
      location.href = `./case.html?id=${encodeURIComponent(nextId)}`;
    }

    $("#tool").value = "";
    $("#toolBadge").textContent = $("#tool").value || "—";
    $("#user").value = "";
    $("#userBadge").textContent = $("#user").value || "—";

    $("#tool").addEventListener("input", () => { setTool($("#tool").value); });
    $("#user").addEventListener("input", () => {
      const v = ($("#user").value || "").trim();
      $("#userBadge").textContent = v || "—";
    });

    $("#btnPrev").addEventListener("click", () => go(-1));
    $("#btnNext").addEventListener("click", () => go(1));

    document.addEventListener("keydown", (e) => {
      const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
      if(tag === "input" || tag === "textarea" || tag === "select") return;

      if(e.key === "n" || e.key === "N") { e.preventDefault(); go(1); }
      else if(e.key === "p" || e.key === "P") { e.preventDefault(); go(-1); }
      else if(e.key === "f" || e.key === "F") { e.preventDefault(); $("#btnFreeze").click(); }
    });


    $("#h1").textContent = c.id;
    $("#caseTitle").innerHTML = `${displayTitle(c.title)} <span class="badge ${badgeClass(c.expected)}">${String(c.expected).toUpperCase()}</span>`;
    $("#caseMeta").innerHTML = `
      <span class="badge">${c.id}</span>
      <span class="badge">${(c.sc||[]).join(",")}</span>
      <span class="badge">tags: ${(c.tags||[]).join(", ")}</span>
    `;

    const html = await fetchText(c.snippet);
    $("#mount").innerHTML = html;
    runInlineScripts($("#mount"));
    renderCanvases($("#mount"));
    setTimeout(() => renderCanvases($("#mount")), 0);

    const vp = $("#mount .viewport");
    if (vp) {
      const baseW = 330;
      const baseH = 170;
      vp.style.width = baseW + "px";
      vp.style.height = baseH + "px";
      vp.style.transform = "none";
      $("#mount").style.width = baseW + "px";
      $("#mount").style.height = baseH + "px";
      $("#mount").style.margin = "0 auto";
    }

    if (c.notes && c.notes.trim()) {
      $("#notesText").textContent = c.notes;
      $("#notesText").style.display = "block";
    }

    $("#btnFreeze").addEventListener("click", () => setFreeze($("#btnFreeze").dataset.on !== "1"));
    $("#sim").addEventListener("change", (e) => setSim(e.target.value));

    setFreeze(true);
    setSim("none");
  }

  main().catch(err => {
    $("#mount").innerHTML = `<div class="viewport"><span class="label">error</span></div><p class="note">${String(err)}</p>`;
  });

  function runInlineScripts(container) {
    const scripts = Array.from(container.querySelectorAll("script"));
    for (const old of scripts) {
      const s = document.createElement("script");
      if (old.type) s.type = old.type;
      if (old.noModule) s.noModule = true;
      s.textContent = old.textContent || "";
      old.replaceWith(s);
    }
  }

  function renderCanvases(container) {
    const canvases = Array.from(container.querySelectorAll("canvas"));
    for (const c of canvases) {
      requestAnimationFrame(() => {
        const ctx = c.getContext && c.getContext("2d");
        if (!ctx) return;
        const w = c.clientWidth || 900;
        const h = c.clientHeight || 340;
        c.width = w; c.height = h;
        ctx.fillStyle = "#111827";
        ctx.fillRect(0, 0, w, h);
        ctx.fillStyle = "#ffffff";
        ctx.font = "800 84px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("CANVAS", w / 2, h / 2);
      });
    }
  }
</script>
</body>
</html>
